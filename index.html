<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æµé€ï¼šç”Ÿå­˜æŒ‘æˆ° (Engine Refactor)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;600&display=swap" rel="stylesheet">
    <style>
        /* æ¨£å¼ä¿æŒåŸæ¨£ï¼Œç¢ºä¿è¦–è¦ºé«”é©—ä¸€è‡´ */
        :root {
            --paper-bg: #f7f5f0;
            --ink-black: #2c2c2c;
            --muted-gold: #c7b299;
            --sage-green: #8da399;
            --dusty-pink: #d8c3c3;
            --font-serif: 'Noto Serif TC', serif;
        }
        body { 
            margin: 0; overflow: hidden; background: var(--paper-bg); 
            font-family: var(--font-serif); user-select: none; -webkit-user-select: none;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; color: var(--ink-black); position: relative;
            touch-action: none; -webkit-touch-callout: none;
        }
        #zen-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; overflow: hidden; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E"); }
        #leaderboard { position: absolute; bottom: 40px; background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.05); padding: 25px; text-align: left; width: 80%; max-width: 300px; z-index: 5; border-radius: 2px; }
        #btn { border-radius: 50%; display: none; align-items: center; justify-content: center; position: absolute; z-index: 50; cursor: crosshair; color: #fff; background: var(--sage-green); box-shadow: 0 10px 30px rgba(141, 163, 153, 0.4); writing-mode: vertical-rl; text-orientation: upright; letter-spacing: 5px; will-change: transform; }
        #timer { position: absolute; top: 10%; font-size: 3.5rem; font-weight: 300; color: var(--ink-black); z-index: 60; pointer-events: none; text-align: center; width: 100%; }
        #msg { position: absolute; top: 25%; left: 50%; transform: translateX(-50%); min-width: 220px; font-size: 18px; color: var(--ink-black); opacity: 0; text-align: center; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); padding: 20px 30px; border-radius: 50px; z-index: 60; pointer-events: none; transition: opacity 0.3s; }
        #roach-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; pointer-events: none; }
        .roach { position: absolute; font-size: 40px; filter: drop-shadow(6px 8px 5px rgba(0,0,0,0.3)); will-change: transform; pointer-events: none; }
        #name-modal { position: absolute; top:0; left:0; width:100%; height:100%; background: var(--paper-bg); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        /* åƒ…åˆ—å‡ºé—œéµæ¨£å¼ï¼Œå…¶é¤˜çœç•¥ä»¥ä¿æŒç²¾ç°¡ */
        input { background: transparent; border: none; border-bottom: 1px solid #ddd; padding: 10px; font-size: 20px; text-align: center; width: 200px; margin-bottom: 40px; outline: none; }
        button { padding: 12px 40px; font-size: 14px; background: transparent; border: 1px solid var(--ink-black); cursor: pointer; border-radius: 50px; }
    </style>
</head>
<body oncontextmenu="return false;">
    <audio id="bgm" loop><source src="https://files.freemusicarchive.org/storage-freemusicarchive-org/music/no_curator/Kevin_MacLeod/Classical_Sampler/Kevin_MacLeod_-_Erik_Satie_Gymnopedie_No_1.mp3" type="audio/mpeg"></audio>
    <div id="roach-layer"></div>
    <div id="zen-bg"></div>
    <div id="name-modal">
        <h2>ç•™ä¸‹å°è¨˜</h2>
        <input type="text" id="playerNameInput" placeholder="ä½ çš„åå­—" maxlength="10">
        <button onclick="saveName()">é€²å…¥</button>
    </div>
    <div id="timer">0.00 <small>SECONDS</small></div>
    <div id="msg"></div>
    <div id="btn">è§¸ç¢°</div>

    <script>
        const btn = document.getElementById('btn');
        const roachLayer = document.getElementById('roach-layer');
        const bgm = document.getElementById('bgm');
        
        let state = {
            isPlaying: false,
            lastFrameTime: 0,
            elapsed: 0,
            btnX: window.innerWidth / 2, btnY: window.innerHeight / 2,
            targetX: window.innerWidth / 2, targetY: window.innerHeight / 2,
            vx: 0, vy: 0,
            fingerX: 0, fingerY: 0,
            currentRadius: 130,
            roaches: [] // ä¸­å¤®é›†æ¬Šçš„èŸ‘è‚æ± 
        };

        const CFG = {
            startRadius: 130, minRadius: 60, shrinkTime: 90,
            inertia: 0.02,
            roachLimit: 50
        };

        function gameLoop(timestamp) {
            if (!state.isPlaying) return;
            if (!state.lastFrameTime) state.lastFrameTime = timestamp;
            const dt = (timestamp - state.lastFrameTime) / 1000;
            state.lastFrameTime = timestamp;
            state.elapsed += dt;

            updateGame(dt);
            renderGame();

            requestAnimationFrame(gameLoop);
        }

        function updateGame(dt) {
            // 1. æŒ‰éˆ•ç‰©ç†é‹ç®—
            const distToTarget = Math.hypot(state.targetX - state.btnX, state.targetY - state.btnY);
            if (distToTarget < 50 || Math.random() < 0.01) {
                const margin = state.currentRadius + 50;
                state.targetX = margin + Math.random() * (window.innerWidth - margin * 2);
                state.targetY = margin + Math.random() * (window.innerHeight - margin * 2);
            }

            const dx = state.targetX - state.btnX;
            const dy = state.targetY - state.btnY;
            const dist = Math.hypot(dx, dy) || 1;
            const maxSpeed = 100 + (state.elapsed * 5); // æ¯ç§’ç§»å‹•åƒç´ 
            
            const targetVX = (dx / dist) * maxSpeed;
            const targetVY = (dy / dist) * maxSpeed;

            state.vx += (targetVX - state.vx) * CFG.inertia;
            state.vy += (targetVY - state.vy) * CFG.inertia;
            state.btnX += state.vx * dt;
            state.btnY += state.vy * dt;

            // 2. ç¸®å°é‚è¼¯
            state.currentRadius = Math.max(CFG.minRadius, CFG.startRadius - (CFG.startRadius - CFG.minRadius) * (state.elapsed / CFG.shrinkTime));

            // 3. èŸ‘è‚ç”Ÿæˆèˆ‡ AI é‚è¼¯
            if (state.elapsed > 10 && state.roaches.length < CFG.roachLimit) {
                const chance = 0.5 * dt; // æ¯ç§’ 0.5 éš»çš„æœŸæœ›å€¼
                if (Math.random() < chance) spawnRoachData();
            }

            updateRoaches(dt);

            // 4. æ­»äº¡åˆ¤å®š
            const distFinger = Math.hypot(state.fingerX - state.btnX, state.fingerY - state.btnY);
            if (distFinger > state.currentRadius + 20) gameOver();
        }

        function spawnRoachData() {
            const side = Math.floor(Math.random() * 4);
            let x, y;
            if (side === 0) { x = Math.random() * window.innerWidth; y = -50; }
            else if (side === 1) { x = window.innerWidth + 50; y = Math.random() * window.innerHeight; }
            else if (side === 2) { x = Math.random() * window.innerWidth; y = window.innerHeight + 50; }
            else { x = -50; y = Math.random() * window.innerHeight; }

            const el = document.createElement('div');
            el.className = 'roach';
            el.innerText = 'ğŸª³';
            el.style.fontSize = (30 + Math.random() * 30) + 'px';
            roachLayer.appendChild(el);

            state.roaches.push({
                el: el,
                x: x, y: y,
                vx: 0, vy: 0,
                angle: 0,
                mode: 'WAIT', // WAIT, DASH, SCATTER
                timer: Math.random() * 0.5
            });
        }

        function updateRoaches(dt) {
            state.roaches.forEach(r => {
                r.timer -= dt;
                
                if (r.timer <= 0) {
                    // ç°¡å–®ç‹€æ…‹æ©Ÿ
                    if (r.mode === 'WAIT') {
                        r.mode = 'DASH';
                        r.timer = 0.2 + Math.random() * 0.3;
                        const angle = Math.atan2(state.btnX - r.x, state.btnY - r.y); // æ³¨æ„é€™è£¡ç”¨ä¾†å°æº–ç›®æ¨™
                        r.vx = Math.sin(angle) * 400;
                        r.vy = Math.cos(angle) * 400;
                        r.angle = -angle * (180/Math.PI) + 180;
                    } else {
                        r.mode = 'WAIT';
                        r.timer = 0.1 + Math.random() * 0.5;
                        r.vx = 0; r.vy = 0;
                    }
                }

                r.x += r.vx * dt;
                r.y += r.vy * dt;
            });
        }

        function renderGame() {
            // æ¸²æŸ“æŒ‰éˆ•
            const r = state.currentRadius;
            btn.style.width = (r * 2) + 'px';
            btn.style.height = (r * 2) + 'px';
            btn.style.transform = `translate3d(${state.btnX - r}px, ${state.btnY - r}px, 0)`;
            
            // æ¸²æŸ“è¨ˆæ™‚å™¨
            document.getElementById('timer').innerHTML = state.elapsed.toFixed(2) + " <small>SECONDS</small>";

            // æ¸²æŸ“èŸ‘è‚ (ä¸­å¤®çµ±ç±Œæ¸²æŸ“)
            state.roaches.forEach(r => {
                r.el.style.transform = `translate3d(${r.x}px, ${r.y}px, 0) rotate(${r.angle}deg)`;
            });
        }

        function saveName() {
            const val = document.getElementById('playerNameInput').value.trim();
            if(!val) return;
            document.getElementById('name-modal').style.display = 'none';
            btn.style.display = 'flex';
            resetGameState();
        }

        function resetGameState() {
            state.isPlaying = false;
            state.elapsed = 0;
            state.lastFrameTime = 0;
            state.roaches.forEach(r => r.el.remove());
            state.roaches = [];
            state.btnX = window.innerWidth / 2;
            state.btnY = window.innerHeight / 2;
            btn.innerText = "è§¸ç¢°";
            btn.style.color = "#fff";
            renderGame();
        }

        function gameOver() {
            state.isPlaying = false;
            bgm.pause();
            bgm.currentTime = 0;
            document.getElementById('msg').style.opacity = 1;
            document.getElementById('msg').innerHTML = `æ•£äº†<br>${state.elapsed.toFixed(2)}`;
            setTimeout(resetGameState, 2000);
        }

        function startInteraction(e) {
            if (state.isPlaying) return;
            const p = e.touches ? e.touches[0] : e;
            if (Math.hypot(p.clientX - state.btnX, p.clientY - state.btnY) < state.currentRadius) {
                state.isPlaying = true;
                btn.innerText = "";
                bgm.play();
                requestAnimationFrame(gameLoop);
            }
        }

        function moveInteraction(e) {
            const p = e.touches ? e.touches[0] : e;
            state.fingerX = p.clientX;
            state.fingerY = p.clientY;
            if(state.isPlaying) e.preventDefault();
        }

        window.addEventListener('touchstart', startInteraction, {passive:false});
        window.addEventListener('mousedown', startInteraction);
        window.addEventListener('touchmove', moveInteraction, {passive:false});
        window.addEventListener('mousemove', moveInteraction);
        window.addEventListener('touchend', () => state.isPlaying && gameOver());
        window.addEventListener('mouseup', () => state.isPlaying && gameOver());
    </script>
</body>
</html>
